{"uid":"2a8bcc693ab5dd87","name":"Cannot publish service with deprecated model — admin_client_with_valid_api_key","fullName":"tests.test_model_management.test_model_management_update_services.TestModelManagementUpdateServices#test_cannot_publish_service_with_deprecated_model","historyId":"d582f7eab4c3e4c00914811667f48d67","time":{"start":1771863815470,"stop":1771863817005,"duration":1535},"description":"\n        BUSINESS RULE: Cannot publish a service when its associated model is deprecated\n        Flow: Create model → create service → deprecate model → attempt publish service → expect 400/422/409\n        Expected: 400/422/409 with error details\n        ","descriptionHtml":"<pre><code>    BUSINESS RULE: Cannot publish a service when its associated model is deprecated\n    Flow: Create model → create service → deprecate model → attempt publish service → expect 400/422/409\n    Expected: 400/422/409 with error details\n</code></pre>\n","status":"failed","statusMessage":"AssertionError: [ADMIN] Expected 400/409/422 — cannot publish service with deprecated model, got 200. Response: \"Service 'f50f4bcbd24d729965bd6d2d8a9f960a' updated successfully.\"\nassert 200 in [400, 409, 422]\n +  where 200 = <Response [200 OK]>.status_code","statusTrace":"self = <test_model_management_update_services.TestModelManagementUpdateServices object at 0x76faef859fc0>\nrole_client_fixture = 'admin_client_with_valid_api_key'\nrequest = <FixtureRequest for <Function test_cannot_publish_service_with_deprecated_model[admin_client_with_valid_api_key]>>\n\n    @allure.severity(allure.severity_level.CRITICAL)\n    @allure.issue(\"BR-08\", \"API allows publishing service with deprecated model\")\n    @allure.title(\"Cannot publish service with deprecated model — {role_client_fixture}\")\n    @pytest.mark.business_case\n    @pytest.mark.parametrize(\"role_client_fixture\", [\n        \"admin_client_with_valid_api_key\",\n        \"moderator_client_with_valid_api_key\"\n    ])\n    def test_cannot_publish_service_with_deprecated_model(self, role_client_fixture, request):\n        \"\"\"\n        BUSINESS RULE: Cannot publish a service when its associated model is deprecated\n        Flow: Create model → create service → deprecate model → attempt publish service → expect 400/422/409\n        Expected: 400/422/409 with error details\n        \"\"\"\n        client = request.getfixturevalue(role_client_fixture)\n        role_name = role_client_fixture.replace(\"_client_with_valid_api_key\", \"\").upper()\n        timestamp = int(time.time())\n        model_uuid = None\n    \n        try:\n            # STEP 1: Create a model\n            model_name = ServiceWithPayloads.model_name(\n                role_name=role_name,\n                timestamp=timestamp\n            )\n            model_payload = ServiceWithPayloads.model_create_payload(\n                name=model_name,\n                version=\"1.0.0\",\n                task_type=\"asr\"\n            )\n            create_model_response = client.post(settings.MODEL_MANAGEMENT_CREATE, json=model_payload)\n            assert create_model_response.status_code in [200, 201], (\n                f\"[{role_name}] Model creation failed. Response: {create_model_response.text}\"\n            )\n            print(f\"\\n✅ [{role_name}] Model created: {model_name}\")\n    \n            # STEP 2: Fetch modelId + uuid from list\n            list_response = client.get(settings.MODEL_MANAGEMENT_LIST, params={\"model_name\": model_name})\n            assert list_response.status_code == 200\n            models = list_response.json()\n            assert len(models) > 0, f\"[{role_name}] Could not find model '{model_name}'\"\n            model_id = models[0][\"modelId\"]\n            model_uuid = models[0][\"uuid\"]\n            model_version = models[0][\"version\"]\n            print(f\"\uD83D\uDD0D [{role_name}] modelId: {model_id} | version: {model_version}\")\n    \n            # STEP 3: Create a service (unpublished by default)\n            service_name = ServiceWithPayloads.service_name(\n                prefix=\"dep-pub\",\n                role_name=role_name,\n                timestamp=timestamp\n            )\n            service_payload = ServiceWithPayloads.service_create_payload(\n                model_id=model_id,\n                model_version=model_version,\n                service_name=service_name\n            )\n            create_service_response = client.post(\n                settings.MODEL_MANAGEMENT_CREATE_SERVICES,\n                json=service_payload\n            )\n            assert create_service_response.status_code in [200, 201], (\n                f\"[{role_name}] Service creation failed. Response: {create_service_response.text}\"\n            )\n            print(f\"✅ [{role_name}] Service created (unpublished): {service_name}\")\n    \n            # STEP 4: Fetch serviceId from list\n            services_response = client.get(\n                settings.MODEL_MANAGEMENT_LIST_SERVICES,\n                params={\"is_published\": False}\n            )\n            assert services_response.status_code == 200\n            services = services_response.json()\n            created_service = next(\n                (s for s in services if s.get(\"name\") == service_name), None\n            )\n            assert created_service is not None, (\n                f\"[{role_name}] Could not find service '{service_name}' in list\"\n            )\n            service_id = created_service[\"serviceId\"]\n            print(f\"\uD83D\uDD0D [{role_name}] serviceId: {service_id}\")\n    \n            # STEP 5: Deprecate the model\n            deprecate_payload = ServiceWithPayloads.model_update_payload(\n                model_id=model_id,\n                uuid=model_uuid,\n                version=model_version,\n                version_status=\"DEPRECATED\",\n                task_type=\"asr\"\n            )\n            deprecate_response = client.patch(settings.MODEL_MANAGEMENT_UPDATE, json=deprecate_payload)\n            assert deprecate_response.status_code == 200, (\n                f\"[{role_name}] Model deprecation failed. Response: {deprecate_response.text}\"\n            )\n            print(f\"✅ [{role_name}] Model deprecated successfully\")\n    \n            # STEP 6: Attempt to publish the service\n            publish_payload = ServiceWithPayloads.service_update_payload(\n                service_id=service_id,\n                is_published=True\n            )\n    \n            print(f\"\\n{'='*60}\")\n            print(f\"\uD83D\uDD0D Business Rule: Cannot Publish Service with Deprecated Model - {role_name}\")\n            print(f\"\uD83D\uDD0D Endpoint: PATCH {settings.MODEL_MANAGEMENT_UPDATE_SERVICES}\")\n            print(f\"\uD83D\uDD0D serviceId: {service_id} | model versionStatus: DEPRECATED\")\n            print(f\"{'='*60}\")\n    \n            response = client.patch(settings.MODEL_MANAGEMENT_UPDATE_SERVICES, json=publish_payload)\n    \n            print(f\"\uD83D\uDCCA Status Code: {response.status_code}\")\n            print(f\"\uD83D\uDCE6 Response: {response.text}\")\n    \n            # ASSERTION 1: Should be rejected\n>           assert response.status_code in [400, 409, 422], (\n                f\"[{role_name}] Expected 400/409/422 — cannot publish service with deprecated model, \"\n                f\"got {response.status_code}. Response: {response.text}\"\n            )\nE           AssertionError: [ADMIN] Expected 400/409/422 — cannot publish service with deprecated model, got 200. Response: \"Service 'f50f4bcbd24d729965bd6d2d8a9f960a' updated successfully.\"\nE           assert 200 in [400, 409, 422]\nE            +  where 200 = <Response [200 OK]>.status_code\n\ntests/test_model_management/test_model_management_update_services.py:657: AssertionError","flaky":false,"newFailed":false,"newBroken":false,"newPassed":false,"retriesCount":0,"retriesStatusChange":false,"beforeStages":[{"name":"event_loop_policy","time":{"start":1771863794716,"stop":1771863794716,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"admin_token_manager","time":{"start":1771863794717,"stop":1771863810148,"duration":15431},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"admin_client_with_valid_api_key","time":{"start":1771863810148,"stop":1771863810148,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false}],"testStage":{"description":"\n        BUSINESS RULE: Cannot publish a service when its associated model is deprecated\n        Flow: Create model → create service → deprecate model → attempt publish service → expect 400/422/409\n        Expected: 400/422/409 with error details\n        ","status":"failed","statusMessage":"AssertionError: [ADMIN] Expected 400/409/422 — cannot publish service with deprecated model, got 200. Response: \"Service 'f50f4bcbd24d729965bd6d2d8a9f960a' updated successfully.\"\nassert 200 in [400, 409, 422]\n +  where 200 = <Response [200 OK]>.status_code","statusTrace":"self = <test_model_management_update_services.TestModelManagementUpdateServices object at 0x76faef859fc0>\nrole_client_fixture = 'admin_client_with_valid_api_key'\nrequest = <FixtureRequest for <Function test_cannot_publish_service_with_deprecated_model[admin_client_with_valid_api_key]>>\n\n    @allure.severity(allure.severity_level.CRITICAL)\n    @allure.issue(\"BR-08\", \"API allows publishing service with deprecated model\")\n    @allure.title(\"Cannot publish service with deprecated model — {role_client_fixture}\")\n    @pytest.mark.business_case\n    @pytest.mark.parametrize(\"role_client_fixture\", [\n        \"admin_client_with_valid_api_key\",\n        \"moderator_client_with_valid_api_key\"\n    ])\n    def test_cannot_publish_service_with_deprecated_model(self, role_client_fixture, request):\n        \"\"\"\n        BUSINESS RULE: Cannot publish a service when its associated model is deprecated\n        Flow: Create model → create service → deprecate model → attempt publish service → expect 400/422/409\n        Expected: 400/422/409 with error details\n        \"\"\"\n        client = request.getfixturevalue(role_client_fixture)\n        role_name = role_client_fixture.replace(\"_client_with_valid_api_key\", \"\").upper()\n        timestamp = int(time.time())\n        model_uuid = None\n    \n        try:\n            # STEP 1: Create a model\n            model_name = ServiceWithPayloads.model_name(\n                role_name=role_name,\n                timestamp=timestamp\n            )\n            model_payload = ServiceWithPayloads.model_create_payload(\n                name=model_name,\n                version=\"1.0.0\",\n                task_type=\"asr\"\n            )\n            create_model_response = client.post(settings.MODEL_MANAGEMENT_CREATE, json=model_payload)\n            assert create_model_response.status_code in [200, 201], (\n                f\"[{role_name}] Model creation failed. Response: {create_model_response.text}\"\n            )\n            print(f\"\\n✅ [{role_name}] Model created: {model_name}\")\n    \n            # STEP 2: Fetch modelId + uuid from list\n            list_response = client.get(settings.MODEL_MANAGEMENT_LIST, params={\"model_name\": model_name})\n            assert list_response.status_code == 200\n            models = list_response.json()\n            assert len(models) > 0, f\"[{role_name}] Could not find model '{model_name}'\"\n            model_id = models[0][\"modelId\"]\n            model_uuid = models[0][\"uuid\"]\n            model_version = models[0][\"version\"]\n            print(f\"\uD83D\uDD0D [{role_name}] modelId: {model_id} | version: {model_version}\")\n    \n            # STEP 3: Create a service (unpublished by default)\n            service_name = ServiceWithPayloads.service_name(\n                prefix=\"dep-pub\",\n                role_name=role_name,\n                timestamp=timestamp\n            )\n            service_payload = ServiceWithPayloads.service_create_payload(\n                model_id=model_id,\n                model_version=model_version,\n                service_name=service_name\n            )\n            create_service_response = client.post(\n                settings.MODEL_MANAGEMENT_CREATE_SERVICES,\n                json=service_payload\n            )\n            assert create_service_response.status_code in [200, 201], (\n                f\"[{role_name}] Service creation failed. Response: {create_service_response.text}\"\n            )\n            print(f\"✅ [{role_name}] Service created (unpublished): {service_name}\")\n    \n            # STEP 4: Fetch serviceId from list\n            services_response = client.get(\n                settings.MODEL_MANAGEMENT_LIST_SERVICES,\n                params={\"is_published\": False}\n            )\n            assert services_response.status_code == 200\n            services = services_response.json()\n            created_service = next(\n                (s for s in services if s.get(\"name\") == service_name), None\n            )\n            assert created_service is not None, (\n                f\"[{role_name}] Could not find service '{service_name}' in list\"\n            )\n            service_id = created_service[\"serviceId\"]\n            print(f\"\uD83D\uDD0D [{role_name}] serviceId: {service_id}\")\n    \n            # STEP 5: Deprecate the model\n            deprecate_payload = ServiceWithPayloads.model_update_payload(\n                model_id=model_id,\n                uuid=model_uuid,\n                version=model_version,\n                version_status=\"DEPRECATED\",\n                task_type=\"asr\"\n            )\n            deprecate_response = client.patch(settings.MODEL_MANAGEMENT_UPDATE, json=deprecate_payload)\n            assert deprecate_response.status_code == 200, (\n                f\"[{role_name}] Model deprecation failed. Response: {deprecate_response.text}\"\n            )\n            print(f\"✅ [{role_name}] Model deprecated successfully\")\n    \n            # STEP 6: Attempt to publish the service\n            publish_payload = ServiceWithPayloads.service_update_payload(\n                service_id=service_id,\n                is_published=True\n            )\n    \n            print(f\"\\n{'='*60}\")\n            print(f\"\uD83D\uDD0D Business Rule: Cannot Publish Service with Deprecated Model - {role_name}\")\n            print(f\"\uD83D\uDD0D Endpoint: PATCH {settings.MODEL_MANAGEMENT_UPDATE_SERVICES}\")\n            print(f\"\uD83D\uDD0D serviceId: {service_id} | model versionStatus: DEPRECATED\")\n            print(f\"{'='*60}\")\n    \n            response = client.patch(settings.MODEL_MANAGEMENT_UPDATE_SERVICES, json=publish_payload)\n    \n            print(f\"\uD83D\uDCCA Status Code: {response.status_code}\")\n            print(f\"\uD83D\uDCE6 Response: {response.text}\")\n    \n            # ASSERTION 1: Should be rejected\n>           assert response.status_code in [400, 409, 422], (\n                f\"[{role_name}] Expected 400/409/422 — cannot publish service with deprecated model, \"\n                f\"got {response.status_code}. Response: {response.text}\"\n            )\nE           AssertionError: [ADMIN] Expected 400/409/422 — cannot publish service with deprecated model, got 200. Response: \"Service 'f50f4bcbd24d729965bd6d2d8a9f960a' updated successfully.\"\nE           assert 200 in [400, 409, 422]\nE            +  where 200 = <Response [200 OK]>.status_code\n\ntests/test_model_management/test_model_management_update_services.py:657: AssertionError","steps":[],"attachments":[{"uid":"1a026387cdcb4930","name":"Request — POST","source":"1a026387cdcb4930.json","type":"application/json","size":1742},{"uid":"7cda6dd26c92aa38","name":"Response — 200","source":"7cda6dd26c92aa38.json","type":"application/json","size":111},{"uid":"ee93afe6d57c703c","name":"Request — GET","source":"ee93afe6d57c703c.json","type":"application/json","size":117},{"uid":"1e7f926189ea8395","name":"Response — 200","source":"1e7f926189ea8395.json","type":"application/json","size":1707},{"uid":"f658c143ff9034c2","name":"Request — POST","source":"f658c143ff9034c2.json","type":"application/json","size":419},{"uid":"7e33b0aec34c7b31","name":"Response — 200","source":"7e33b0aec34c7b31.json","type":"application/json","size":119},{"uid":"c51e34c240a01a2f","name":"Request — GET","source":"c51e34c240a01a2f.json","type":"application/json","size":99},{"uid":"43e66c12368a434c","name":"Response — 200","source":"43e66c12368a434c.json","type":"application/json","size":13472},{"uid":"92a950c11e0f29c7","name":"Request — PATCH","source":"92a950c11e0f29c7.json","type":"application/json","size":1474},{"uid":"186cfe96a2a4d89b","name":"Response — 200","source":"186cfe96a2a4d89b.json","type":"application/json","size":77},{"uid":"ba246377e02b23ce","name":"Request — PATCH","source":"ba246377e02b23ce.json","type":"application/json","size":261},{"uid":"f7bb1ed6c54e9583","name":"Response — 200","source":"f7bb1ed6c54e9583.json","type":"application/json","size":79},{"uid":"b2a84895a21d72ce","name":"Request — PATCH","source":"b2a84895a21d72ce.json","type":"application/json","size":262},{"uid":"6bb7db7cb0c31776","name":"Response — 200","source":"6bb7db7cb0c31776.json","type":"application/json","size":79},{"uid":"e5ee3ca56b947df0","name":"Request — DELETE","source":"e5ee3ca56b947df0.json","type":"application/json","size":118},{"uid":"a7c3a94603399711","name":"Response — 200","source":"a7c3a94603399711.json","type":"application/json","size":81},{"uid":"85ce750cc7a5d58e","name":"stdout","source":"85ce750cc7a5d58e.txt","type":"text/plain","size":850}],"parameters":[],"shouldDisplayMessage":true,"stepsCount":0,"attachmentsCount":17,"hasContent":true,"attachmentStep":false},"afterStages":[{"name":"admin_token_manager::0","time":{"start":1771863840151,"stop":1771863830524,"duration":-9627},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false}],"labels":[{"name":"severity","value":"critical"},{"name":"story","value":"Update Services"},{"name":"feature","value":"Model Management"},{"name":"tag","value":"business_case"},{"name":"parentSuite","value":"tests.test_model_management"},{"name":"suite","value":"test_model_management_update_services"},{"name":"subSuite","value":"TestModelManagementUpdateServices"},{"name":"host","value":"TI-LAP-1094"},{"name":"thread","value":"570854-MainThread"},{"name":"framework","value":"pytest"},{"name":"language","value":"cpython3"},{"name":"package","value":"tests.test_model_management.test_model_management_update_services"},{"name":"resultFormat","value":"allure2"}],"parameters":[{"name":"role_client_fixture","value":"'admin_client_with_valid_api_key'"}],"links":[{"name":"API allows publishing service with deprecated model","url":"BR-08","type":"issue"}],"hidden":false,"retry":false,"extra":{"severity":"critical","retries":[],"categories":[{"name":"Product defects","matchedStatuses":[],"flaky":false}],"tags":["business_case"]},"source":"2a8bcc693ab5dd87.json","parameterValues":["'admin_client_with_valid_api_key'"]}